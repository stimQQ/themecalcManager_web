<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡ç®—å™¨çš®è‚¤ä¸»é¢˜ç®¡ç†ç³»ç»Ÿ - ä»ªè¡¨ç›˜</title>
    <!-- DNSé¢„è§£æ -->
    <link rel="dns-prefetch" href="https://www.themecalc.com">
    <link rel="preconnect" href="https://www.themecalc.com" crossorigin>
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="preload" href="js/utils.js" as="script">
    <link rel="preload" href="js/auth.js" as="script">
    <!-- æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="/favicon.ico.png" type="image/png">
    <!-- å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <div class="loading-message">åŠ è½½ä¸­...</div>
    </div>
    
    <!-- æ¶ˆæ¯å®¹å™¨ -->
    <div id="messagesContainer" class="messages-container"></div>
    
    <!-- é¡µé¢å®¹å™¨ -->
    <div class="page-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo">ThemeCalc</h1>
                <span class="sidebar-close">&times;</span>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html"><span class="icon">ğŸ¨</span> ä¸»é¢˜ç®¡ç†</a></li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
            </div>
        </aside>
    </div>
    
    <!-- è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        async function checkLoginStatus() {
            utils.showLoading('æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€...');
            
            try {
                const isLoggedIn = await authAPI.verifyToken();
                
                if (!isLoggedIn) {
                    utils.showMessage('warning', 'æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 2000, () => {
                        authAPI.logout();
                        window.location.href = 'login.html';
                    });
                    return false;
                }
                
                return true;
            } catch (error) {
                utils.showMessage('error', `éªŒè¯ç™»å½•çŠ¶æ€å‡ºé”™: ${error.message}`, 3000);
                return false;
            } finally {
                utils.hideLoading();
            }
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const token = authAPI.getToken();
                
                if (!token) return;
                
                const userData = authAPI.getCurrentUser();
                
                if (userData && userData.username) {
                    document.getElementById('userName').textContent = userData.username;
                    document.getElementById('userRole').textContent = userData.role || 'ç®¡ç†å‘˜';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            utils.showLoading('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®...');
            
            try {
                // è¿™é‡Œåº”è¯¥æ˜¯ä»APIè·å–æ•°æ®ï¼Œä½†ä¸ºäº†ç¤ºä¾‹ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                setTimeout(() => {
                    // æ›´æ–°æ‘˜è¦å¡ç‰‡æ•°æ®
                    document.getElementById('totalThemes').textContent = '328';
                    document.getElementById('totalUsers').textContent = '1,245';
                    document.getElementById('monthlyDownloads').textContent = '8,674';
                    document.getElementById('monthlyRevenue').textContent = 'Â¥5,283';
                    
                    // æ¸²æŸ“ä¸‹è½½è¶‹åŠ¿å›¾è¡¨
                    renderDownloadsChart();
                    
                    // æ¸²æŸ“ä¸»é¢˜åˆ†ç±»å›¾è¡¨
                    renderCategoriesChart();
                    
                    // åŠ è½½æœ€è¿‘æ´»åŠ¨
                    loadRecentActivities();
                    
                    utils.hideLoading();
                }, 800);
            } catch (error) {
                utils.showMessage('error', `åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥: ${error.message}`, 3000);
                utils.hideLoading();
            }
        }
        
        // æ¸²æŸ“ä¸‹è½½è¶‹åŠ¿å›¾è¡¨
        function renderDownloadsChart() {
            const ctx = document.getElementById('downloadsChart').getContext('2d');
            
            const labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const data = {
                labels: labels,
                datasets: [{
                    label: 'å…è´¹ä¸»é¢˜ä¸‹è½½',
                    data: [2430, 3210, 2850, 3310, 3980, 4250, 3890, 4520, 5210, 5680, 6120, 5880],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'ä»˜è´¹ä¸»é¢˜ä¸‹è½½',
                    data: [420, 580, 510, 690, 780, 950, 870, 1050, 1240, 1380, 1520, 1670],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“ä¸»é¢˜åˆ†ç±»å›¾è¡¨
        function renderCategoriesChart() {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            
            const data = {
                labels: ['ç®€çº¦', 'ç‚«å½©', 'å•†åŠ¡', 'æš—é»‘', 'è‡ªç„¶', 'æœªåˆ†ç±»'],
                datasets: [{
                    label: 'ä¸»é¢˜æ•°é‡',
                    data: [85, 64, 47, 53, 39, 40],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ],
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        // åŠ è½½æœ€è¿‘æ´»åŠ¨
        function loadRecentActivities() {
            const activitiesContainer = document.getElementById('recentActivities');
            
            // æ¨¡æ‹Ÿæ•°æ®
            const activities = [
                { type: 'theme_create', user: 'å¼ æ˜', theme: 'æ·±ç©ºè“è°ƒ', time: 'ä»Šå¤© 14:23' },
                { type: 'theme_update', user: 'æçº¢', theme: 'æç®€ç™½', time: 'ä»Šå¤© 11:05' },
                { type: 'user_register', user: 'ç‹å¼º', time: 'æ˜¨å¤© 18:47' },
                { type: 'theme_delete', user: 'ç®¡ç†å‘˜', theme: 'æµ‹è¯•ä¸»é¢˜', time: 'æ˜¨å¤© 16:30' },
                { type: 'theme_download', user: 'é™ˆå°æ˜', theme: 'æš—å¤œæ¨¡å¼', time: 'å‰å¤© 09:15' }
            ];
            
            activitiesContainer.innerHTML = '';
            
            activities.forEach(activity => {
                const activityEl = document.createElement('div');
                activityEl.className = 'activity-item';
                
                let activityContent = '';
                
                switch (activity.type) {
                    case 'theme_create':
                        activityContent = `<strong>${activity.user}</strong> åˆ›å»ºäº†æ–°ä¸»é¢˜ <strong>${activity.theme}</strong>`;
                        break;
                    case 'theme_update':
                        activityContent = `<strong>${activity.user}</strong> æ›´æ–°äº†ä¸»é¢˜ <strong>${activity.theme}</strong>`;
                        break;
                    case 'theme_delete':
                        activityContent = `<strong>${activity.user}</strong> åˆ é™¤äº†ä¸»é¢˜ <strong>${activity.theme}</strong>`;
                        break;
                    case 'user_register':
                        activityContent = `æ–°ç”¨æˆ· <strong>${activity.user}</strong> æ³¨å†Œäº†è´¦å·`;
                        break;
                    case 'theme_download':
                        activityContent = `<strong>${activity.user}</strong> ä¸‹è½½äº†ä¸»é¢˜ <strong>${activity.theme}</strong>`;
                        break;
                }
                
                activityEl.innerHTML = `
                    <div class="activity-content">${activityContent}</div>
                    <div class="activity-time">${activity.time}</div>
                `;
                
                activitiesContainer.appendChild(activityEl);
            });
        }
        
        // æ›´æ–°å½“å‰æ—¥æœŸæ˜¾ç¤º
        function updateDateDisplay() {
            const dateEl = document.getElementById('currentDate');
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString('zh-CN', options);
        }
        
        // å¤„ç†é€€å‡ºç™»å½•
        function handleLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    utils.showMessage('info', 'æ­£åœ¨é€€å‡ºç™»å½•...', 1500, () => {
                        authAPI.logout();
                        window.location.href = 'login.html';
                    });
                });
            }
        }
        
        // åˆå§‹åŒ–ä¾§è¾¹æ åˆ‡æ¢
        function initSidebarToggle() {
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarClose = document.querySelector('.sidebar-close');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
                
                if (sidebarClose) {
                    sidebarClose.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                    });
                }
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–ä¾§è¾¹æ åˆ‡æ¢
            initSidebarToggle();
            
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            updateDateDisplay();
            
            // å¤„ç†é€€å‡ºç™»å½•
            handleLogout();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const isLoggedIn = await checkLoginStatus();
            
            if (isLoggedIn) {
                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                await loadUserInfo();
                
                // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
                await loadDashboardData();
                
                utils.showMessage('success', 'æ¬¢è¿å›æ¥ï¼Œä»ªè¡¨ç›˜å·²æ›´æ–°', 3000);
            }
        });
    </script>
</body>
</html> 